<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion Gated Player - Hybrid Edition</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0a0a0a;
            --panel-color: #161616;
            --accent-color: #00e5ff; /* サイバーブルーに変更 */
            --active-color: #00ff88;
            --stop-color: #ff0055;
            --text-color: #e0e0e0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- ヘッダー --- */
        header {
            width: 100%;
            padding: 15px 0;
            background: linear-gradient(to bottom, #000, transparent);
            text-align: center;
            margin-bottom: 10px;
        }
        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 2px; text-transform: uppercase; color: var(--accent-color); text-shadow: 0 0 10px rgba(0,229,255,0.3); }

        /* --- メインコンテナ --- */
        .main-container {
            width: 95%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-bottom: 50px;
        }

        /* --- 状態インジケータ --- */
        .status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--panel-color);
            padding: 15px 20px;
            border-radius: 12px;
            border: 1px solid #333;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .status-text {
            font-size: 1.2rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 100px;
        }
        .status-active { color: var(--active-color); text-shadow: 0 0 8px var(--active-color); }
        .status-inactive { color: var(--stop-color); text-shadow: 0 0 8px var(--stop-color); }

        /* --- メーターUI --- */
        .meter-wrapper {
            flex-grow: 1;
            margin-left: 20px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            transition: opacity 0.3s;
        }
        .meter-label { font-size: 0.7rem; color: #888; display: flex; justify-content: space-between; }
        
        .meter-track {
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .meter-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent-color), #fff);
            border-radius: 4px;
            box-shadow: 0 0 10px var(--accent-color);
            transition: width 0.1s linear;
        }
        .meter-hidden { opacity: 0; pointer-events: none; }

        /* --- プレイヤー --- */
        .player-frame {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid #333;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        .player-frame iframe {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }

        /* --- コントロールパネル --- */
        .control-panel {
            background: var(--panel-color);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid #333;
        }

        .panel-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        /* 入力フォーム */
        .input-group { flex: 1; display: flex; gap: 10px; }
        input[type="text"] {
            flex: 1; background: #222; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 8px; outline: none;
        }
        input[type="text"]:focus { border-color: var(--accent-color); }

        /* ボタン */
        button {
            background: #333; color: #fff; border: 1px solid #444; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.2s;
        }
        button:hover { background: #444; }
        button.primary { background: var(--accent-color); color: #000; border: none; }
        button.primary:hover { background: #33eaff; box-shadow: 0 0 15px rgba(0,229,255,0.4); }

        button.start-btn {
            width: 100%; padding: 20px; font-size: 1.2rem;
            background: linear-gradient(45deg, var(--accent-color), #0091ea);
            color: #000; border: none;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* トグルスイッチ */
        .toggle-container {
            display: flex; align-items: center; gap: 10px; cursor: pointer; user-select: none;
            background: #222; padding: 8px 15px; border-radius: 20px; border: 1px solid #444;
        }
        .toggle-checkbox { display: none; }
        .toggle-switch {
            width: 40px; height: 20px; background: #555; border-radius: 20px; position: relative; transition: 0.3s;
        }
        .toggle-switch::after {
            content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: #fff; border-radius: 50%; transition: 0.3s;
        }
        .toggle-checkbox:checked + .toggle-switch { background: var(--accent-color); }
        .toggle-checkbox:checked + .toggle-switch::after { transform: translateX(20px); }
        .toggle-label { font-size: 0.9rem; color: #ccc; }

        /* スライダー周り */
        .slider-group { flex: 1; min-width: 200px; }
        .slider-label { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 5px; color: #aaa; }
        input[type="range"] { width: 100%; cursor: pointer; accent-color: var(--accent-color); }

        /* プリセットタグ */
        .preset-tags { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .tag {
            font-size: 0.8rem; padding: 5px 12px; background: #333; border-radius: 20px; cursor: pointer; white-space: nowrap; border: 1px solid transparent;
        }
        .tag:hover { border-color: var(--accent-color); color: var(--accent-color); }

        #hidden-process { position: absolute; visibility: hidden; }
    </style>
</head>
<body>

    <header>
        <h1><i class="fas fa-network-wired"></i> Kinetic Stream v6</h1>
    </header>

    <div class="main-container">
        
        <button id="startBtn" class="start-btn"><i class="fas fa-power-off"></i> システム起動</button>

        <div class="status-bar">
            <div id="statusIndicator" class="status-text status-inactive">
                <i class="fas fa-pause"></i> <span>STOP</span>
            </div>
            
            <div class="meter-wrapper" id="meterWrapper">
                <div class="meter-label">
                    <span>ACTIVITY LEVEL</span>
                    <span id="meterValue">0%</span>
                </div>
                <div class="meter-track">
                    <div id="motionBar" class="meter-fill"></div>
                </div>
            </div>

            <div style="margin-left: 10px;">
                <button onclick="toggleMeter()" style="padding: 5px 10px;" title="メーター表示切替"><i class="fas fa-eye"></i></button>
            </div>
        </div>

        <div class="player-frame">
            <div id="player"></div>
        </div>

        <div class="control-panel">
            <div class="panel-row" style="justify-content: center; padding-bottom: 15px; border-bottom: 1px solid #333;">
                <label class="toggle-container" title="ONにすると、マウス移動やキーボード入力も「動き」として検知します">
                    <input type="checkbox" id="pcInputToggle" class="toggle-checkbox" checked>
                    <div class="toggle-switch"></div>
                    <span class="toggle-label"><i class="fas fa-keyboard"></i> PC操作も検知に含める (作業用)</span>
                </label>
            </div>

            <div class="panel-row">
                <div class="input-group">
                    <input type="text" id="videoUrl" placeholder="YouTube URL貼り付け">
                    <button class="primary" onclick="loadFromUrl()">再生</button>
                </div>
                <button onclick="openYouTubeSearch()"><i class="fab fa-youtube"></i> 検索</button>
            </div>

            <div class="panel-row" style="display: block;">
                <div style="font-size: 0.8rem; color: #888; margin-bottom: 8px;">プリセット:</div>
                <div class="preset-tags">
                    <div class="tag" onclick="setVideo('jfKfPfyJRdk')">Lo-Fi HipHop</div>
                    <div class="tag" onclick="setVideo('5qap5aO4i9A')">Synthwave</div>
                    <div class="tag" onclick="setVideo('lTRiuFIWV54')">Metal</div>
                    <div class="tag" onclick="setVideo('teIjhVd9jFk')">Workout</div>
                    <div class="tag" onclick="setVideo('gDnE-5lD7w8')">Nature</div>
                </div>
            </div>

            <div class="panel-row">
                <div class="slider-group">
                    <div class="slider-label"><span>カメラ感度 (高⇔低)</span> <span id="sensVal">50</span></div>
                    <input type="range" id="sensitivity" min="10" max="150" value="50">
                </div>
                <div class="slider-group">
                    <div class="slider-label"><span>停止までの余韻 (秒)</span> <span id="decayVal">2.0s</span></div>
                    <input type="range" id="decay" min="0.5" max="10.0" value="2.0" step="0.5">
                </div>
            </div>
        </div>
    </div>

    <div id="hidden-process">
        <video id="webcam" playsinline muted width="320" height="240"></video>
        <canvas id="diff-canvas" width="320" height="240"></canvas>
    </div>

    <script>
        // --- YouTube API ---
        let player;
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                videoId: 'jfKfPfyJRdk',
                playerVars: { 'playsinline': 1, 'rel': 0 },
            });
        }

        function loadFromUrl() {
            const url = document.getElementById('videoUrl').value;
            let vid = extractVideoID(url);
            if(vid && player && player.loadVideoById) player.loadVideoById(vid);
        }
        function setVideo(id) {
            if(player && player.loadVideoById) player.loadVideoById(id);
            document.getElementById('videoUrl').value = "https://youtu.be/" + id;
        }
        function openYouTubeSearch() { window.open("https://www.youtube.com", "_blank"); }
        function extractVideoID(url) {
            if (url.includes('v=')) return url.split('v=')[1].split('&')[0];
            if (url.includes('youtu.be/')) return url.split('youtu.be/')[1].split('?')[0];
            return url.length === 11 ? url : null;
        }

        // --- Logic ---
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('diff-canvas');
        const ctx = canvas.getContext('2d');
        
        // UI Elements
        const startBtn = document.getElementById('startBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const motionBar = document.getElementById('motionBar');
        const meterValue = document.getElementById('meterValue');
        const meterWrapper = document.getElementById('meterWrapper');
        
        // Settings
        const sensInput = document.getElementById('sensitivity');
        const decayInput = document.getElementById('decay');
        const sensValDisp = document.getElementById('sensVal');
        const decayValDisp = document.getElementById('decayVal');
        const pcInputToggle = document.getElementById('pcInputToggle');

        sensInput.addEventListener('input', (e) => sensValDisp.innerText = e.target.value);
        decayInput.addEventListener('input', (e) => decayValDisp.innerText = e.target.value + "s");

        let lastImageData = null;
        let lastActiveTime = 0; 
        let isRunning = false;
        let currentState = "STOPPED"; 
        let isMeterVisible = true;
        let pcInputDetectedFrame = false; // 今のフレームでPC操作があったか

        // --- PC Input Listeners ---
        function onPcInput() {
            if (!isRunning || !pcInputToggle.checked) return;
            lastActiveTime = Date.now();
            pcInputDetectedFrame = true;
        }
        // マウス移動とキー操作を監視
        document.addEventListener('mousemove', onPcInput);
        document.addEventListener('keydown', onPcInput);
        document.addEventListener('click', onPcInput);
        document.addEventListener('scroll', onPcInput);


        function toggleMeter() {
            isMeterVisible = !isMeterVisible;
            meterWrapper.classList.toggle('meter-hidden', !isMeterVisible);
        }

        startBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 320, height: 240 } });
                video.srcObject = stream;
                video.onloadedmetadata = () => { video.play(); };

                if(player && player.playVideo) {
                    player.mute(); player.playVideo();
                    setTimeout(() => { player.pauseVideo(); player.unMute(); }, 500);
                }

                startBtn.style.display = 'none';
                isRunning = true;
                loop();
            } catch(e) {
                alert("カメラの起動に失敗しました。");
            }
        });

        function loop() {
            if(!isRunning) return;

            let score = 0;

            // 1. カメラ処理
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = frame.data;
                
                if (lastImageData) {
                    const lastData = lastImageData.data;
                    for (let i = 0; i < data.length; i += 4 * 20) {
                        const diff = Math.abs(data[i] - lastData[i]) + Math.abs(data[i+1] - lastData[i+1]) + Math.abs(data[i+2] - lastData[i+2]);
                        if (diff > 40) score++;
                    }
                }
                lastImageData = frame;
            }

            // 2. カメラ検知判定
            const threshold = parseInt(sensInput.value);
            if (score > (threshold / 2)) {
                lastActiveTime = Date.now();
            }

            // 3. メーター表示の計算 (PC操作があれば強制MAX)
            let displayScore = Math.min(100, score / 3);
            if (pcInputDetectedFrame) {
                displayScore = 100; // PC操作時はメーター振り切れ
                pcInputDetectedFrame = false; // フラグリセット
            }

            if (isMeterVisible) {
                motionBar.style.width = displayScore + "%";
                meterValue.innerText = Math.floor(displayScore) + "%";
                // メーターの色変化
                if(displayScore > 80) motionBar.style.background = "var(--active-color)";
                else motionBar.style.background = "linear-gradient(90deg, var(--accent-color), #fff)";
            }

            // 4. 再生/停止判定
            const now = Date.now();
            const decayMs = parseFloat(decayInput.value) * 1000;
            
            if (now < lastActiveTime + decayMs) {
                if (currentState !== "PLAYING") {
                    currentState = "PLAYING";
                    statusIndicator.innerHTML = '<i class="fas fa-play"></i> <span>ACTIVE</span>';
                    statusIndicator.className = "status-text status-active";
                    if(player && player.playVideo) player.playVideo();
                }
            } else {
                if (currentState !== "STOPPED") {
                    currentState = "STOPPED";
                    statusIndicator.innerHTML = '<i class="fas fa-pause"></i> <span>STOP</span>';
                    statusIndicator.className = "status-text status-inactive";
                    if(player && player.pauseVideo) player.pauseVideo();
                }
            }

            requestAnimationFrame(loop);
        }
    </script>
</body>
</html>
