<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion Gated Player - Cyber Edition</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0a0a0a;
            --panel-color: #161616;
            --accent-color: #00ff88; /* ネオングリーン */
            --stop-color: #ff0055;   /* ネオンレッド */
            --text-color: #e0e0e0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- ヘッダー --- */
        header {
            width: 100%;
            padding: 15px 0;
            background: linear-gradient(to bottom, #000, transparent);
            text-align: center;
            margin-bottom: 10px;
        }
        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 2px; text-transform: uppercase; color: var(--accent-color); text-shadow: 0 0 10px rgba(0,255,136,0.3); }

        /* --- メインコンテナ --- */
        .main-container {
            width: 95%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-bottom: 50px;
        }

        /* --- 状態インジケータ --- */
        .status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--panel-color);
            padding: 15px 20px;
            border-radius: 12px;
            border: 1px solid #333;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .status-text {
            font-size: 1.2rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-active { color: var(--accent-color); text-shadow: 0 0 8px var(--accent-color); }
        .status-inactive { color: var(--stop-color); text-shadow: 0 0 8px var(--stop-color); }

        /* --- メーターUI --- */
        .meter-wrapper {
            flex-grow: 1;
            margin-left: 20px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            transition: opacity 0.3s;
        }
        .meter-label { font-size: 0.7rem; color: #888; display: flex; justify-content: space-between; }
        
        .meter-track {
            height: 12px;
            background: #333;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        .meter-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent-color), #fff);
            border-radius: 6px;
            box-shadow: 0 0 10px var(--accent-color);
            transition: width 0.1s linear;
        }
        .meter-hidden { opacity: 0; pointer-events: none; }

        /* --- プレイヤー --- */
        .player-frame {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid #333;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        .player-frame iframe {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }

        /* --- コントロールパネル --- */
        .control-panel {
            background: var(--panel-color);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid #333;
        }

        .panel-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }
        .panel-row:last-child { margin-bottom: 0; }

        /* 入力フォーム */
        .input-group {
            flex: 1;
            display: flex;
            gap: 10px;
        }
        input[type="text"] {
            flex: 1;
            background: #222;
            border: 1px solid #444;
            color: #fff;
            padding: 10px;
            border-radius: 8px;
            outline: none;
        }
        input[type="text"]:focus { border-color: var(--accent-color); }

        /* ボタン */
        button {
            background: #333;
            color: #fff;
            border: 1px solid #444;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        button:hover { background: #444; }
        button.primary { background: var(--accent-color); color: #000; border: none; }
        button.primary:hover { background: #00cc6a; box-shadow: 0 0 15px rgba(0,255,136,0.4); }

        button.start-btn {
            width: 100%; padding: 20px; font-size: 1.2rem;
            background: linear-gradient(45deg, #ff5722, #ff9100);
            color: white; border: none;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* スライダー周り */
        .slider-group { flex: 1; min-width: 200px; }
        .slider-label { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 5px; color: #aaa; }
        input[type="range"] { width: 100%; cursor: pointer; accent-color: var(--accent-color); }

        /* プリセットタグ */
        .preset-tags { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .tag {
            font-size: 0.8rem; padding: 5px 12px; background: #333; border-radius: 20px; cursor: pointer; white-space: nowrap; border: 1px solid transparent;
        }
        .tag:hover { border-color: var(--accent-color); color: var(--accent-color); }

        /* 隠し要素 */
        #hidden-process { position: absolute; top: -9999px; left: -9999px; visibility: hidden; }
    </style>
</head>
<body>

    <header>
        <h1><i class="fas fa-bolt"></i> Kinetic Stream</h1>
    </header>

    <div class="main-container">
        
        <button id="startBtn" class="start-btn"><i class="fas fa-camera"></i> カメラを起動してスタート</button>

        <div class="status-bar">
            <div id="statusIndicator" class="status-text status-inactive">
                <i class="fas fa-pause-circle"></i> <span>STOP</span>
            </div>
            
            <div class="meter-wrapper" id="meterWrapper">
                <div class="meter-label">
                    <span>MOTION LEVEL</span>
                    <span id="meterValue">0%</span>
                </div>
                <div class="meter-track">
                    <div id="motionBar" class="meter-fill"></div>
                </div>
            </div>

            <div style="margin-left: 10px;">
                <button onclick="toggleMeter()" style="padding: 5px 10px; font-size:0.8rem;" title="メーター表示/非表示">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
        </div>

        <div class="player-frame">
            <div id="player"></div>
        </div>

        <div class="control-panel">
            <div class="panel-row">
                <div class="input-group">
                    <input type="text" id="videoUrl" placeholder="YouTubeのURLを貼り付け (例: https://youtu.be/xxx)">
                    <button class="primary" onclick="loadFromUrl()">再生</button>
                </div>
                <button onclick="openYouTubeSearch()"><i class="fab fa-youtube"></i> 動画を探す</button>
            </div>

            <div class="panel-row" style="display: block;">
                <div style="font-size: 0.8rem; color: #888; margin-bottom: 8px;">おすすめプリセット:</div>
                <div class="preset-tags">
                    <div class="tag" onclick="setVideo('jfKfPfyJRdk')">Lo-Fi HipHop</div>
                    <div class="tag" onclick="setVideo('5qap5aO4i9A')">Lofi Girl (Synthwave)</div>
                    <div class="tag" onclick="setVideo('lTRiuFIWV54')">激しいメタル</div>
                    <div class="tag" onclick="setVideo('teIjhVd9jFk')">EDM Workout</div>
                    <div class="tag" onclick="setVideo('gDnE-5lD7w8')">自然の風景</div>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid #333; margin: 15px 0;">

            <div class="panel-row">
                <div class="slider-group">
                    <div class="slider-label"><span>感度 (左:高感度 ⇔ 右:低感度)</span> <span id="sensVal">50</span></div>
                    <input type="range" id="sensitivity" min="10" max="150" value="50">
                </div>
                <div class="slider-group">
                    <div class="slider-label"><span>停止までの余韻 (秒)</span> <span id="decayVal">2.0s</span></div>
                    <input type="range" id="decay" min="0.2" max="5.0" value="2.0" step="0.1">
                </div>
            </div>
        </div>
    </div>

    <div id="hidden-process">
        <video id="webcam" playsinline muted width="320" height="240"></video>
        <canvas id="diff-canvas" width="320" height="240"></canvas>
    </div>

    <script>
        // --- 1. YouTube API ---
        let player;
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                videoId: 'jfKfPfyJRdk',
                playerVars: { 'playsinline': 1, 'rel': 0 },
            });
        }

        // 動画ロード関数
        function loadFromUrl() {
            const url = document.getElementById('videoUrl').value;
            let vid = extractVideoID(url);
            if(vid) {
                if(player && player.loadVideoById) player.loadVideoById(vid);
            } else {
                alert("URLから動画IDを認識できませんでした。\n正しいYouTubeのURLか確認してください。");
            }
        }

        function setVideo(id) {
            if(player && player.loadVideoById) player.loadVideoById(id);
            document.getElementById('videoUrl').value = "https://youtu.be/" + id;
        }

        function openYouTubeSearch() {
            window.open("https://www.youtube.com", "_blank");
        }

        function extractVideoID(url) {
            let videoId = null;
            if (url.includes('v=')) {
                videoId = url.split('v=')[1].split('&')[0];
            } else if (url.includes('youtu.be/')) {
                videoId = url.split('youtu.be/')[1].split('?')[0];
            } else if (url.length === 11) {
                videoId = url; // ID直接入力の場合
            }
            return videoId;
        }

        // --- 2. UI & Motion Logic ---
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('diff-canvas');
        const ctx = canvas.getContext('2d');
        
        // UI Elements
        const startBtn = document.getElementById('startBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const motionBar = document.getElementById('motionBar');
        const meterValue = document.getElementById('meterValue');
        const meterWrapper = document.getElementById('meterWrapper');
        
        // Settings
        const sensInput = document.getElementById('sensitivity');
        const decayInput = document.getElementById('decay');
        const sensValDisp = document.getElementById('sensVal');
        const decayValDisp = document.getElementById('decayVal');

        sensInput.addEventListener('input', (e) => sensValDisp.innerText = e.target.value);
        decayInput.addEventListener('input', (e) => decayValDisp.innerText = e.target.value + "s");

        // 状態変数
        let lastImageData = null;
        let lastActiveTime = 0; 
        let isRunning = false;
        let currentState = "STOPPED"; 
        let isMeterVisible = true;

        // メーター切替
        function toggleMeter() {
            isMeterVisible = !isMeterVisible;
            if(isMeterVisible) {
                meterWrapper.classList.remove('meter-hidden');
            } else {
                meterWrapper.classList.add('meter-hidden');
            }
        }

        // スタート処理
        startBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 320, height: 240 } });
                video.srcObject = stream;
                
                // ★重要: ここで確実に再生を開始させる
                video.onloadedmetadata = () => {
                    video.play();
                };

                // 自動再生制限解除の儀式
                if(player && player.playVideo) {
                    player.mute(); 
                    player.playVideo();
                    setTimeout(() => {
                        player.pauseVideo();
                        player.unMute();
                    }, 500);
                }

                startBtn.style.display = 'none';
                isRunning = true;
                loop();
            } catch(e) {
                alert("カメラエラー: " + e.name + "\nブラウザの設定でカメラを許可してください。");
            }
        });

        function loop() {
            if(!isRunning) return;

            // 映像処理
            // videoが準備できていない場合のエラー回避
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = frame.data;
                let score = 0;

                if (lastImageData) {
                    const lastData = lastImageData.data;
                    // 負荷軽減のためスキップスキャン (20ピクセルおき)
                    for (let i = 0; i < data.length; i += 4 * 20) {
                        const r = Math.abs(data[i] - lastData[i]);
                        const g = Math.abs(data[i+1] - lastData[i+1]);
                        const b = Math.abs(data[i+2] - lastData[i+2]);
                        // ノイズ除去のための最小変化量
                        if (r + g + b > 40) score++;
                    }
                }
                lastImageData = frame;

                // UI更新 (メーター)
                const displayScore = Math.min(100, score / 3); // スケール調整
                if (isMeterVisible) {
                    motionBar.style.width = displayScore + "%";
                    meterValue.innerText = Math.floor(displayScore) + "%";
                }

                // 判定ロジック
                const threshold = parseInt(sensInput.value); // 感度
                const now = Date.now();

                // 閾値を超えたら「動いた時刻」を更新
                // ★修正: 感度スライダーのロジックを直感的に (左=敏感=低い閾値 / 右=鈍感=高い閾値)
                // scoreは動きの量。thresholdは「必要な動きの量」。
                // score > threshold ならOK。
                if (score > (threshold / 2)) { // 調整係数
                    lastActiveTime = now;
                }

                const decayMs = parseFloat(decayInput.value) * 1000;
                const timeDiff = now - lastActiveTime;

                if (timeDiff < decayMs) {
                    // --- 再生 ---
                    if (currentState !== "PLAYING") {
                        currentState = "PLAYING";
                        statusIndicator.innerHTML = '<i class="fas fa-play-circle"></i> <span>ACTIVE</span>';
                        statusIndicator.className = "status-text status-active";
                        if(player && player.playVideo) player.playVideo();
                    }
                } else {
                    // --- 停止 ---
                    if (currentState !== "STOPPED") {
                        currentState = "STOPPED";
                        statusIndicator.innerHTML = '<i class="fas fa-pause-circle"></i> <span>STOP</span>';
                        statusIndicator.className = "status-text status-inactive";
                        if(player && player.pauseVideo) player.pauseVideo();
                    }
                }
            }

            requestAnimationFrame(loop);
        }
    </script>
</body>
</html>
