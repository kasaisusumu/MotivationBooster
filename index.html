<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion Gated YouTube v4</title>
    <style>
        body {
            font-family: sans-serif;
            background: #121212;
            color: #fff;
            text-align: center;
            margin: 0;
            padding: 20px;
        }
        h1 { font-size: 1.2rem; margin-bottom: 10px; color: #ddd; }

        #container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* --- 動画エリア --- */
        .video-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 */
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #333;
            /* v4変更点：pointer-events: none を削除し、操作可能にしました */
        }
        .video-wrapper iframe {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }

        /* --- メーター表示 --- */
        .meter-container {
            background: #222;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        progress {
            flex-grow: 1;
            height: 20px;
            border-radius: 5px;
        }
        progress::-webkit-progress-bar { background-color: #444; border-radius: 5px; }
        progress::-webkit-progress-value { background-color: #4caf50; border-radius: 5px; transition: width 0.1s; }
        
        .status-indicator {
            padding: 5px 15px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9rem;
            min-width: 80px;
        }
        .status-stop { background: #b71c1c; color: #fff; }
        .status-go { background: #2e7d32; color: #fff; box-shadow: 0 0 10px #2e7d32; }

        /* --- コントロール --- */
        .controls {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            text-align: left;
        }
        .row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .row:last-child { margin-bottom: 0; }
        
        input[type="text"] {
            flex-grow: 1; padding: 8px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px;
        }
        button {
            padding: 8px 16px; cursor: pointer; background: #2196f3; color: white; border: none; border-radius: 4px;
        }
        button:hover { background: #1976d2; }
        
        #startBtn {
            width: 100%; padding: 15px; font-size: 1.2rem; background: #ff5722; font-weight: bold; margin-bottom: 10px;
        }

        #hidden-process { display: none; }
    </style>
</head>
<body>

    <h1>Motion Gated YouTube v4 (Interactive)</h1>

    <div id="container">
        <button id="startBtn">カメラを起動してシステム開始</button>

        <div class="meter-container">
            <div style="font-size:0.8rem; width:50px;">動き量:</div>
            <progress id="motionMeter" value="0" max="100"></progress>
            <div id="statusDisplay" class="status-indicator status-stop">停止</div>
        </div>

        <div class="video-wrapper">
            <div id="player"></div>
        </div>

        <div class="controls">
            <div class="row">
                <input type="text" id="videoIdInput" value="jfKfPfyJRdk" placeholder="動画URL または ID">
                <button onclick="changeVideo()">動画変更</button>
            </div>
            <div class="row">
                <div style="flex:1">
                    <label style="font-size:0.8rem; display:block;">感度 (右に行くほど鈍感)</label>
                    <input type="range" id="sensitivity" min="10" max="150" value="50" style="width:100%">
                </div>
                <div style="flex:1">
                    <label style="font-size:0.8rem; display:block;">余韻 (秒)</label>
                    <input type="range" id="decay" min="0.2" max="5.0" value="1.5" step="0.1" style="width:100%">
                </div>
            </div>
            <div class="row" style="font-size:0.8rem; color:#aaa; justify-content:center;">
                ※動画ロゴをクリックして別タブが開いた場合、自動停止しません。<br>この画面内で再生してください。
            </div>
        </div>
    </div>

    <div id="hidden-process">
        <video id="webcam" autoplay playsinline muted width="320" height="240"></video>
        <canvas id="diff-canvas" width="320" height="240"></canvas>
    </div>

    <script>
        // --- YouTube API ---
        let player;
        
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '360',
                width: '640',
                videoId: 'jfKfPfyJRdk',
                playerVars: {
                    'rel': 0,
                    'playsinline': 1
                }
            });
        }

        function changeVideo() {
            const input = document.getElementById('videoIdInput').value;
            let vid = input;
            if(input.includes('v=')) vid = input.split('v=')[1].split('&')[0];
            else if(input.includes('youtu.be/')) vid = input.split('youtu.be/')[1].split('?')[0];
            
            if(player && player.loadVideoById) {
                player.loadVideoById(vid);
            }
        }

        // --- Motion Logic (Improved Timestamp Based) ---
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('diff-canvas');
        const ctx = canvas.getContext('2d');
        const meter = document.getElementById('motionMeter');
        const statusDisp = document.getElementById('statusDisplay');
        const sensInput = document.getElementById('sensitivity');
        const decayInput = document.getElementById('decay');

        let lastImageData = null;
        let lastActiveTime = 0; 
        let isRunning = false;
        let currentState = "STOPPED"; 

        document.getElementById('startBtn').addEventListener('click', async function() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 320, height: 240 } });
                video.srcObject = stream;
                
                // 自動再生制限の解除のため、一度再生して止める
                if(player && player.playVideo) {
                    player.mute(); 
                    player.playVideo();
                    setTimeout(() => {
                        player.pauseVideo();
                        player.unMute(); // 音声を戻す
                    }, 100); 
                }

                this.style.display = 'none';
                isRunning = true;
                loop();
            } catch(e) {
                alert("カメラエラー: " + e.name);
            }
        });

        function loop() {
            if(!isRunning) return;

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = frame.data;
            let score = 0;

            if (lastImageData) {
                const lastData = lastImageData.data;
                for (let i = 0; i < data.length; i += 4 * 10) {
                    const r = Math.abs(data[i] - lastData[i]);
                    const g = Math.abs(data[i+1] - lastData[i+1]);
                    const b = Math.abs(data[i+2] - lastData[i+2]);
                    if (r+g+b > 50) score++;
                }
            }
            lastImageData = frame;

            const displayValue = Math.min(100, score / 5); 
            meter.value = displayValue;

            const threshold = parseInt(sensInput.value);
            const now = Date.now();

            // 動き検知
            if (score > threshold) {
                lastActiveTime = now;
            }

            // 判定
            const decayMs = parseFloat(decayInput.value) * 1000;
            
            // ユーザーが手動で一時停止ボタンを押した場合は、強制再生しないようにチェックを入れることも可能だが
            // 今回は「動き＝再生」を絶対ルールとする
            
            if (now < lastActiveTime + decayMs) {
                // --- PLAY ---
                if (currentState !== "PLAYING") {
                    // プレイヤーの状態を確認 (1=再生中, 2=一時停止, 5=頭出し)
                    // ユーザーが手動でシークバー操作中は邪魔しないほうがいいが、
                    // シンプルに「動いてるなら再生」を実行
                    if(player && player.playVideo) {
                        player.playVideo();
                        currentState = "PLAYING";
                        statusDisp.innerText = "再生中";
                        statusDisp.className = "status-indicator status-go";
                    }
                }
            } else {
                // --- STOP ---
                if (currentState !== "STOPPED") {
                    if(player && player.pauseVideo) {
                        player.pauseVideo();
                        currentState = "STOPPED";
                        statusDisp.innerText = "停止";
                        statusDisp.className = "status-indicator status-stop";
                    }
                }
            }

            requestAnimationFrame(loop);
        }
    </script>
</body>
</html>